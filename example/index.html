<!DOCTYPE html>
<html>
<head>
  <title>Demo</title>
  <script src="../node_modules/phoria.js/scripts/gl-matrix.js"></script>
  <script src="../node_modules/phoria.js/scripts/phoria-util.js"></script>
  <script src="../node_modules/phoria.js/scripts/phoria-entity.js"></script>
  <script src="../node_modules/phoria.js/scripts/phoria-scene.js"></script>
  <script src="../node_modules/phoria.js/scripts/phoria-renderer.js"></script>
  <script src='../node_modules/phoria.js/scripts/dat.gui.min.js'></script>
  <script src='../dist/index.js'></script>
</head>
<body style="background-color: #bfbfbf">

  <center>
    <canvas id="canvas" width="1800" height="900" style="background-color: #eee"></canvas>
  </center>
  <div style="position: absolute; top: 0; left: 0">
    <input type="text" value="lookAt" id="lookAt">
    <input type="button" value="Look Up" id="lookUp">
    <input type="button" value="Look Down" id="lookDown"><br>
    <input type="text" value="Position" id="position">
    <input type="button" value="Move Up" id="moveUp">
    <input type="button" value="Move Down" id="moveDown"><br>
  </div>
  <script>

    function generateWallZ(x, y, z, width, height, texture, opacity, scale)
    {
      scale = scale || 1;
      x *= scale;
      y *= scale;
      z *= scale;
      width *= scale;
      height *= scale;
      z = z || 0;
      opacity = opacity || 1;

      var wall = Phoria.Entity.create({
        points: [
          {x: 0*width + x, y: 1*height + y, z: z}, // top - left
          {x: 1*width + x, y: 1*height + y, z: z}, // top - right
          {x: 1*width + x, y: 0*height + y, z: z}, // bottom - right
          {x: 0*width + x, y: 0*height + y, z: z}  // bottom - left
        ],
        polygons: [{vertices:[0,1,2,3]}],
        style: {
          shademode: "plain",
          opacity: opacity,
          doublesided: true
        }
      });

      wall.textures.push(texture);
      wall.polygons[0].texture = 0;

      return wall;
    }

    function generateWallY(x, y, z, width, height, texture, opacity, scale)
    {
      scale = scale || 1;
      x *= scale;
      y *= scale;
      z *= scale;
      width *= scale;
      height *= scale;
      z = z || 0;
      opacity = opacity || 1;

      var wall = Phoria.Entity.create({
        points: [
          {x: 0*width + x, y: y, z: 0*height + z}, // top - left
          {x: 1*width + x, y: y, z: 0*height + z}, // top - right
          {x: 1*width + x, y: y, z:-1*height + z}, // bottom - right
          {x: 0*width + x, y: y, z:-1*height + z}  // bottom - left
        ],
        polygons: [{vertices:[0,1,2,3]}],
        style: {
          shademode: "plain",
          opacity: opacity,
          doublesided: true
        }
      });

      wall.textures.push(texture);
      wall.polygons[0].texture = 0;

      return wall;
    }

    function generateWallX(x, y, z, width, height, texture, opacity, scale)
    {
      scale = scale || 1;
      x *= scale;
      y *= scale;
      z *= scale;
      width *= scale;
      height *= scale;
      z = z || 0;
      opacity = opacity || 1;

      var wall = Phoria.Entity.create({
        points: [
          {x: x, y: 1*height + y, z: 0*width + z}, // top - left
          {x: x, y: 1*height + y, z:-1*width + z}, // top - right
          {x: x, y: 0*height + y, z:-1*width + z}, // bottom - right
          {x: x, y: 0*height + y, z: 0*width + z}  // bottom - left
        ],
        polygons: [{vertices:[0,1,2,3]}],
        style: {
          shademode: "plain",
          opacity: opacity,
          doublesided: true
        }
      });

      wall.textures.push(texture);
      wall.polygons[0].texture = 0;

      return wall;
    }


    var requestAnimFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame ||
                       window.mozRequestAnimationFrame || window.msRequestAnimationFrame || 
                       function(c) {window.setTimeout(c, 15)};

    window.addEventListener('load', onloadHandler, false);
    var tiles = [];
    var backgrounds = [];
    var foregrounds = [];
    function onloadHandler()
    {
       // get the images loading
      var loader = new Phoria.Preloader();
      backgrounds.push(new Image());
      loader.addImage(backgrounds[0], 'images/room_foreground_47.png');

      foregrounds.push(new Image());
      loader.addImage(foregrounds[0], 'images/room_background_47.png');

      tiles.push(new Image());
      loader.addImage(tiles[0], 'images/tile_242.jpg');
      tiles.push(new Image());
      loader.addImage(tiles[1], 'images/tile_1.jpg');
      tiles.push(new Image());
      loader.addImage(tiles[2], 'images/tile_2.jpg');
       // for (var i=0; i<6; i++)
       // {
       //    bitmaps.push(new Image());
       //    loader.addImage(bitmaps[i], 'images/texture'+i+'.png');
       // }
      loader.onLoadCallback(init);

      function init()
      {
        // get the canvas DOM element and the 2D drawing context
        var canvas = document.getElementById('canvas');

        // create the scene and setup camera, perspective and viewport
        var scene = new Phoria.Scene();
        scene.camera.lookat = {x:0.0, y:3.1, z:34.0};
        scene.camera.position = {x:0.0, y:5.7, z:-20.0};
        scene.perspective.aspect = canvas.width / canvas.height;
        scene.perspective.fov = 14;
        scene.viewport.width = canvas.width;
        scene.viewport.height = canvas.height;

        // create a canvas renderer
        var renderer = new Phoria.CanvasRenderer(canvas);

        // add a grid to help visualise camera position etc.
        var plane = Phoria.Util.generateTesselatedPlane(200,200,0,120);
        scene.graph.push(Phoria.Entity.create({
          points: plane.points,
          edges: plane.edges,
          polygons: plane.polygons,
          style: {
            shademode: "plain",
            drawmode: "wireframe",
            linewidth: 0.25,
            objectsortmode: "back"
          }
        }));

        var wall1 = generateWallZ(-1820,0,8000,3520,1700,tiles[0],1,1/150);
        scene.graph.push(wall1);

        var wall2 = generateWallX(1694,0,8000,4200,1700,tiles[0],1,1/150);
        scene.graph.push(wall2);

        var wall3 = generateWallY(-1800,0,8000,3500,6200,tiles[0],1,1/150);
        scene.graph.push(wall3);

        // wall plane object - constructed in-place to avoid rotations of texture coordinates
        /*var wall = generateWallZ(1600, 900, 20, 1/150);
        wall.textures.push(backgrounds[0]);
        wall.polygons[0].texture = 0;
        scene.graph.push(wall);*/

        /*var wall2 = generateWallZ(0, -320, 1600, 900, 0, 1/150);
        wall2.textures.push(backgrounds[0]);
        wall2.polygons[0].texture = 0;
        scene.graph.push(wall2);

        var wall3 = generateWallY(1600, 900, 0, 1/150);
        wall3.textures.push(tiles[0]);
        wall3.polygons[0].texture = 0;
        scene.graph.push(wall3);*/

        var pause = false;
        var fnAnimate = function() {
          if (!pause)
          {
            // rotate local matrix of the cube
            // cube.rotateY(0.5*Phoria.RADIANS);
            // wall2.rotateY(0.5*Phoria.RADIANS);
            // wall3.rotateY(0.5*Phoria.RADIANS);

            // execute the model view 3D pipeline and render the scene
            scene.modelView();
            renderer.render(scene);
            renderer.renderImage(backgrounds[0], 0, 0, 1800, 900, 0.5);
            renderer.renderImage(foregrounds[0], 0, 0, 1800, 900, 1);
          }
          requestAnimFrame(fnAnimate);
        };

        // add GUI controls
        var gui = new dat.GUI();
        var f = gui.addFolder('Perspective');
        f.add(scene.perspective, "fov").min(5).max(175);
        f.add(scene.perspective, "near").min(1).max(100);
        f.add(scene.perspective, "far").min(1).max(1000);
        f = gui.addFolder('Camera LookAt');
        f.add(scene.camera.lookat, "x").min(-100).max(100);
        f.add(scene.camera.lookat, "y").min(-100).max(100);
        f.add(scene.camera.lookat, "z").min(-100).max(100);
        f = gui.addFolder('Camera Position');
        f.add(scene.camera.position, "x").min(-100).max(100);
        f.add(scene.camera.position, "y").min(-100).max(100);
        f.add(scene.camera.position, "z").min(-100).max(100);
        f = gui.addFolder('Camera Up');
        f.add(scene.camera.up, "x").min(-10).max(10).step(0.1);
        f.add(scene.camera.up, "y").min(-10).max(10).step(0.1);
        f.add(scene.camera.up, "z").min(-10).max(10).step(0.1);

        // start animation
        requestAnimFrame(fnAnimate);

        // events
        document.getElementById('lookUp').addEventListener('click', function () {
          scene.camera.lookat.y += 0.1;
        });
        document.getElementById('lookDown').addEventListener('click', function () {
          scene.camera.lookat.y -= 0.1;
        });
        document.getElementById('moveUp').addEventListener('click', function () {
          scene.camera.position.y += 0.1;
        });
        document.getElementById('moveDown').addEventListener('click', function () {
          scene.camera.position.y -= 0.1;
        });
        window.addEventListener('keydown', function (evn) {
          switch (evn.keyCode) {
            case 87: // w
              scene.camera.lookat.y += 0.1;
              document.getElementById('lookAt').value = scene.camera.lookat.y;
              break;
            case 83: // s
              scene.camera.lookat.y -= 0.1;
              document.getElementById('lookAt').value = scene.camera.lookat.y;
              break;
            case 69: // e
              scene.camera.position.y += 0.1;
              document.getElementById('position').value = scene.camera.position.y;
              break;
            case 68: // d
              scene.camera.position.y -= 0.1;
              document.getElementById('position').value = scene.camera.position.y;
              break;
          }
        });
      }
    }
  </script>
</body>
</html>
